

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>parcels.codegenerator &#8212; Parcels  documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-96368922-1', 'auto');
  ga('send', 'pageview');
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Parcels  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/parcelslogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for parcels.codegenerator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="kn">import</span> <span class="nn">cgen</span> <span class="k">as</span> <span class="nn">c</span>

<span class="kn">from</span> <span class="nn">parcels.field</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">parcels.field</span> <span class="kn">import</span> <span class="n">NestedField</span>
<span class="kn">from</span> <span class="nn">parcels.field</span> <span class="kn">import</span> <span class="n">SummedField</span>
<span class="kn">from</span> <span class="nn">parcels.field</span> <span class="kn">import</span> <span class="n">VectorField</span>
<span class="kn">from</span> <span class="nn">parcels.tools.loggers</span> <span class="kn">import</span> <span class="n">logger</span>


<span class="k">class</span> <span class="nc">IntrinsicNode</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ccode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">ccode</span>


<span class="k">class</span> <span class="nc">FieldSetNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">Field</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                             <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">NestedField</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VectorField</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">NestedVectorFieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                                             <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NestedFieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                                       <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">SummedField</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VectorField</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">SummedVectorFieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                                             <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SummedFieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                                       <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">VectorField</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">VectorFieldNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                                   <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ConstNode</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                             <span class="n">ccode</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">FieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>


<span class="k">class</span> <span class="nc">VectorFieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">VectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">VectorFieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span>  <span class="c1"># second variable for UV interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var3</span> <span class="o">=</span> <span class="n">var3</span>  <span class="c1"># third variable for UVW interpolation</span>


<span class="k">class</span> <span class="nc">SummedFieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SummedFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SummedFieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>


<span class="k">class</span> <span class="nc">SummedVectorFieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SummedVectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SummedVectorFieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span>  <span class="c1"># second variable for UV interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var3</span> <span class="o">=</span> <span class="n">var3</span>  <span class="c1"># third variable for UVW interpolation</span>


<span class="k">class</span> <span class="nc">NestedFieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NestedFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NestedFieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>


<span class="k">class</span> <span class="nc">NestedVectorFieldNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NestedVectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NestedVectorFieldEvalNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># the variable in which the interpolated field is written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span>  <span class="c1"># second variable for UV interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var3</span> <span class="o">=</span> <span class="n">var3</span>  <span class="c1"># third variable for UVW interpolation</span>


<span class="k">class</span> <span class="nc">ConstNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span>


<span class="k">class</span> <span class="nc">MathNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="n">symbol_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pi&#39;</span><span class="p">:</span> <span class="s1">&#39;M_PI&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="s1">&#39;M_E&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">IntrinsicNode</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Unknown math function encountered: </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
                                 <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RandomNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="n">symbol_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_random&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;uniform&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_uniform&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;randint&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_randint&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;normalvariate&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_normalvariate&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;expovariate&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_expovariate&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;vonmisesvariate&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_vonmisesvariate&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="s1">&#39;parcels_seed&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">IntrinsicNode</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Unknown random function encountered: </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
                                 <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ErrorCodeNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="n">symbol_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Success&#39;</span><span class="p">:</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaluate&#39;</span><span class="p">:</span> <span class="s1">&#39;EVALUATE&#39;</span><span class="p">,</span> <span class="s1">&#39;Repeat&#39;</span><span class="p">:</span> <span class="s1">&#39;REPEAT&#39;</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;StopExecution&#39;</span><span class="p">:</span> <span class="s1">&#39;STOP_EXECUTION&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrorInterpolation&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR_INTERPOLATION&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;ErrorOutOfBounds&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR_OUT_OF_BOUNDS&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrorThroughSurface&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR_THROUGH_SURFACE&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">IntrinsicNode</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Unknown error code encountered: </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
                                 <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrintNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="s1">&#39;print&#39;</span>


<span class="k">class</span> <span class="nc">ParticleAttributeNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;</span><span class="si">%s</span><span class="s2">[p]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParticleNode</span><span class="p">(</span><span class="n">IntrinsicNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">variables</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ParticleAttributeNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;delete&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ParticleAttributeNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Particle type </span><span class="si">%s</span><span class="s2"> does not define attribute &quot;</span><span class="si">%s</span><span class="s2">&quot;.</span>
<span class="s2">Please add &#39;</span><span class="si">%s</span><span class="s2">&#39; to </span><span class="si">%s</span><span class="s2">.users_vars or define an appropriate sub-class.&quot;&quot;&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>


<div class="viewcode-block" id="IntrinsicTransformer"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.IntrinsicTransformer">[docs]</a><span class="k">class</span> <span class="nc">IntrinsicTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AST transformer that catches any mention of intrinsic variable</span>
<span class="sd">    names, such as &#39;particle&#39; or &#39;fieldset&#39;, inserts placeholder objects</span>
<span class="sd">    and propagates attribute access.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldset</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span> <span class="o">=</span> <span class="n">fieldset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ptype</span>

        <span class="c1"># Counter and variable names for temporaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># A stack of additonal staements to be inserted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="IntrinsicTransformer.get_tmp"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.IntrinsicTransformer.get_tmp">[docs]</a>    <span class="k">def</span> <span class="nf">get_tmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new temporary veriable name&quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;parcels_tmpvar</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_vars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tmp</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="IntrinsicTransformer.visit_Name"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.IntrinsicTransformer.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inject IntrinsicNode objects into the tree according to keyword&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">FieldSetNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="s1">&#39;fset&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;particle&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">ParticleNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="s1">&#39;particles&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ErrorCode&#39;</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">]:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">ErrorCodeNode</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;math&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">MathNode</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">RandomNode</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">ccode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">PrintNode</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s1">&#39;parcels_tmpvar&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Custom Kernels cannot contain string &#39;parcels_tmpvar&#39;; please change your kernel&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

    <span class="k">def</span> <span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">IntrinsicNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;update_next_dt&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;update_next_dt&#39;</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot convert numpy functions in kernels to C-code.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                          <span class="s2">&quot;Either use functions from the math library or run Parcels in Scipy mode.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                          <span class="s2">&quot;For more information, see http://oceanparcels.org/faq.html#kernelwriting&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &#39;</span><span class="si">%s</span><span class="s2">&#39; used in kernel to C-code&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">)</span>

        <span class="c1"># If we encounter field evaluation we replace it with a</span>
        <span class="c1"># temporary variable and put the evaluation call on the stack.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">SummedFieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">]</span>
            <span class="c1"># Insert placeholder node for field eval ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">SummedFieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)]</span>
            <span class="c1"># .. and return the name of the temporary that will be populated</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">SummedVectorFieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">))]</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">))]</span>
            <span class="n">tmp3</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">if</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">))]</span>
            <span class="c1"># Insert placeholder node for field eval ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">SummedVectorFieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">)]</span>
            <span class="c1"># .. and return the name of the temporary that will be populated</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">tmp3</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp3</span><span class="p">))],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp2</span><span class="p">))],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">FieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="c1"># Insert placeholder node for field eval ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">FieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)]</span>
            <span class="c1"># .. and return the name of the temporary that will be populated</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">VectorFieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="n">tmp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="c1"># Insert placeholder node for field eval ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">VectorFieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">)]</span>
            <span class="c1"># .. and return the name of the temporary that will be populated</span>
            <span class="k">if</span> <span class="n">tmp3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp2</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp3</span><span class="p">)],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp2</span><span class="p">)],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">NestedFieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">NestedFieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">NestedVectorFieldNode</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span>
            <span class="n">tmp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tmp</span><span class="p">()</span> <span class="k">if</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">NestedVectorFieldEvalNode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">tmp3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp2</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp3</span><span class="p">)],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp2</span><span class="p">)],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>

        <span class="c1"># Inject statements from the stack</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+</span> <span class="n">stmts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">stmts</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>

        <span class="c1"># Inject statements from the stack</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">+</span> <span class="n">stmts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stmt_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">stmts</span>

    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ParticleAttributeNode</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">IntrinsicNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;return DELETE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="TupleSplitter"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.TupleSplitter">[docs]</a><span class="k">class</span> <span class="nc">TupleSplitter</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AST transformer that detects and splits Pythonic tuple</span>
<span class="sd">    assignments into multiple statements for conversion to C.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
            <span class="n">t_elts</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">elts</span>
            <span class="n">v_elts</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">elts</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_elts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_elts</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Tuple lenghts in assignment do not agree&quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">t_elts</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">t_elts</span><span class="p">,</span> <span class="n">v_elts</span><span class="p">):</span>
                <span class="n">n</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">n</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="KernelGenerator"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator">[docs]</a><span class="k">class</span> <span class="nc">KernelGenerator</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Code generator class that translates simple Python kernel</span>
<span class="sd">    functions into C functions by populating and accessing the `ccode`</span>
<span class="sd">    attriibute on nodes in the Python AST.&quot;&quot;&quot;</span>

    <span class="c1"># Intrinsic variables that appear as function arguments</span>
    <span class="n">kernel_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;particle&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;output_time&#39;</span><span class="p">,</span> <span class="s1">&#39;tol&#39;</span><span class="p">]</span>
    <span class="n">array_vars</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldset</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span> <span class="o">=</span> <span class="n">fieldset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_field_args</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_args</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">py_ast</span><span class="p">,</span> <span class="n">funcvars</span><span class="p">):</span>
        <span class="c1"># Replace occurences of intrinsic objects in Python AST</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">IntrinsicTransformer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="p">)</span>
        <span class="n">py_ast</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">py_ast</span><span class="p">)</span>

        <span class="c1"># Untangle Pythonic tuple-assignment statements</span>
        <span class="n">py_ast</span> <span class="o">=</span> <span class="n">TupleSplitter</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">py_ast</span><span class="p">)</span>

        <span class="c1"># Store the docstring so that it can be removed in visit_Str (#753)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docstr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">py_ast</span><span class="p">)</span>

        <span class="c1"># Generate C-code for all nodes in the Python AST</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">py_ast</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">py_ast</span><span class="o">.</span><span class="n">ccode</span>

        <span class="c1"># Insert variable declarations for non-instrinsics</span>
        <span class="c1"># Make sure that repeated variables are not declared more than</span>
        <span class="c1"># once. If variables occur in multiple Kernels, give a warning</span>
        <span class="n">used_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">funcvars_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">funcvars</span><span class="p">)</span>  <span class="c1"># editing a list while looping over it is dangerous</span>
        <span class="k">for</span> <span class="n">kvar</span> <span class="ow">in</span> <span class="n">funcvars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kvar</span> <span class="ow">in</span> <span class="n">used_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;particle&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">kvar</span><span class="o">+</span><span class="s2">&quot; declared in multiple Kernels&quot;</span><span class="p">)</span>
                <span class="n">funcvars_copy</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kvar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">used_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kvar</span><span class="p">)</span>
        <span class="n">funcvars</span> <span class="o">=</span> <span class="n">funcvars_copy</span>
        <span class="k">for</span> <span class="n">kvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_vars</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kvar</span> <span class="ow">in</span> <span class="n">funcvars</span><span class="p">:</span>
                <span class="n">funcvars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kvar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;ErrorCode&#39;</span><span class="p">,</span> <span class="s1">&#39;err&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcvars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;type_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">funcvars</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">tmp_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">tmp_vars</span><span class="p">)))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccode</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Generate &quot;ccode&quot; attribute by traversing the Python AST</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">):</span>  <span class="c1"># ignore docstrings</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

        <span class="c1"># Create function declaration and argument list</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">DeclSpecifier</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;ErrorCode&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">spec</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s2">&quot;particles&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;CField&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_field_args</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">fcomponent</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">fcomponent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">ccode_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;CField&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">))]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># field.W does not always exist</span>
        <span class="k">for</span> <span class="n">const</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">const</span><span class="p">)]</span>

        <span class="c1"># Create function body as C-code object</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">stmt</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">)]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;return SUCCESS&quot;</span><span class="p">)]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

<div class="viewcode-block" id="KernelGenerator.visit_Call"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate C code for simple C-style function calls. Please</span>
<span class="sd">        note that starred and keyword arguments are currently not</span>
<span class="sd">        supported.&quot;&quot;&quot;</span>
        <span class="n">pointer_args</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parcels_customed_Cfunc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">PrintNode</span><span class="p">):</span>
            <span class="c1"># Write our own Print parser because Python3-AST does not seem to have one</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;printf(&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;printf(&quot;</span><span class="si">%%</span><span class="s1">f</span><span class="se">\\</span><span class="s1">n&quot;, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="s1">&#39;ccode&#39;</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">ccode</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">id</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="s1">&#39;elts&#39;</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;ccode&#39;</span><span class="p">):</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;printf(&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&quot;&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">s</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;This print statement is not supported in Python3 version of Parcels&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ccode</span> <span class="o">==</span> <span class="s1">&#39;parcels_customed_Cfunc_pointer_args&#39;</span><span class="p">:</span>
                    <span class="n">pointer_args</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">parcels_customed_Cfunc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">ccode</span> <span class="o">==</span> <span class="s1">&#39;parcels_customed_Cfunc&#39;</span><span class="p">:</span>
                    <span class="n">parcels_customed_Cfunc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FieldNode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">VectorFieldNode</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_name</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ParticleNode</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">pointer_args</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&amp;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">ccode</span>
            <span class="n">ccode_args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">pointer_args</span><span class="p">:]])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">ccode_args</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">ccode_args</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parcels_customed_Cfunc</span><span class="p">:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">),</span>
                                                  <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">)]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">rhs</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in converting Kernel to C. See http://oceanparcels.org/#writing-parcels-kernels for hints and tips&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_Name"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Catches any mention of intrinsic variable names, such as</span>
<span class="sd">        &#39;particle&#39; or &#39;fieldset&#39; and inserts our placeholder objects&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span></div>

    <span class="k">def</span> <span class="nf">visit_NameConstant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
            <span class="c1"># Detect in-place initialisation of multi-dimensional arrays</span>
            <span class="n">tmp_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="n">decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="n">decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">ArrayOf</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                    <span class="c1"># Check type and dimension are the same</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Non-list element discovered in array declaration&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Irregular array length not allowed in array declaration&quot;</span><span class="p">)</span>
                <span class="n">tmp_node</span> <span class="o">=</span> <span class="n">tmp_node</span><span class="o">.</span><span class="n">elts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Initializer</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array_vars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span>
                                                <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span>
                                                <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># field evals are replaced by a tmp variable is added to the stack.</span>
        <span class="c1"># Here it means field evals passes from node.test to node.body. We take it out manually</span>
        <span class="n">fieldInTestCount</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">ccode</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;parcels_tmpvar&#39;</span><span class="p">)</span>
        <span class="n">body0</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[:</span><span class="n">fieldInTestCount</span><span class="p">]])</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">fieldInTestCount</span><span class="p">:]])</span>
        <span class="n">orelse</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ifcode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">orelse</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">body0</span><span class="p">,</span> <span class="n">ifcode</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span>
                                   <span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span>

    <span class="k">def</span> <span class="nf">visit_Tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_List</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">FieldNode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">VectorFieldNode</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span><span class="o">.</span><span class="n">ccode</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">IntrinsicNode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subscript not implemented for object type </span><span class="si">%s</span><span class="s2">&quot;</span>
                                      <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BitXor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;JIT kernels do not support the &#39;^&#39; operator.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Did you intend to use the exponential/power operator? In that case, please use &#39;**&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span> <span class="o">==</span> <span class="s1">&#39;pow&#39;</span><span class="p">:</span>  <span class="c1"># catching &#39;**&#39; pow statements</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;pow(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">s_print</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">visit_Add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

    <span class="k">def</span> <span class="nf">visit_UAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

    <span class="k">def</span> <span class="nf">visit_USub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;pow&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">op_str</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">op_str</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_Eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;==&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>

    <span class="k">def</span> <span class="nf">visit_LtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&lt;=&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Gt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">visit_GtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&gt;=&quot;</span>

    <span class="k">def</span> <span class="nf">visit_And</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;&amp;&amp;&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;||&quot;</span>

    <span class="k">def</span> <span class="nf">visit_Not</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span>

    <span class="k">def</span> <span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Else clause in while clauses cannot be translated to C&quot;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DoWhile</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;For loops cannot be translated to C&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="KernelGenerator.visit_FieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_FieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_SummedFieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_SummedFieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_SummedFieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_NestedFieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_NestedFieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_NestedFieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_args</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_VectorFieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_VectorFieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_VectorFieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_field_args</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_SummedVectorFieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_SummedVectorFieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_SummedVectorFieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vector_field_args</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld</span></div>

<div class="viewcode-block" id="KernelGenerator.visit_NestedVectorFieldNode"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.KernelGenerator.visit_NestedVectorFieldNode">[docs]</a>    <span class="k">def</span> <span class="nf">visit_NestedVectorFieldNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record intrinsic fields used in kernel&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vector_field_args</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld</span></div>

    <span class="k">def</span> <span class="nf">visit_ConstNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_args</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ccode</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span>

    <span class="k">def</span> <span class="nf">visit_FieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
        <span class="n">ccode_conv</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
        <span class="n">conv_stat</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span>
                              <span class="n">conv_stat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">visit_VectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var2</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var3</span><span class="p">,</span>
                                               <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                                               <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">!=</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
            <span class="n">ccode_conv1</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">ccode_conv2</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv1</span><span class="p">)),</span>
                          <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var2</span><span class="p">,</span> <span class="n">ccode_conv2</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="n">ccode_conv3</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var3</span><span class="p">,</span> <span class="n">ccode_conv3</span><span class="p">)))</span>
        <span class="n">conv_stat</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">statements</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span>
                              <span class="n">conv_stat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">visit_SummedFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">cstat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fld</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">):</span>
            <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">ccode_conv</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">conv_stat</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv</span><span class="p">))</span>
            <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span> <span class="n">conv_stat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">)]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">cstat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_SummedVectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">cstat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fld</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var2</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var3</span><span class="p">):</span>
            <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">,</span>
                                        <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                                        <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">!=</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
                <span class="n">ccode_conv1</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">ccode_conv2</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv1</span><span class="p">)),</span>
                              <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">ccode_conv2</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">ccode_conv3</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var3</span><span class="p">,</span> <span class="n">ccode_conv3</span><span class="p">)))</span>
            <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">statements</span><span class="p">)]</span>
        <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">)]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">cstat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_NestedFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">cstat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">ccode_conv</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="n">conv_stat</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv</span><span class="p">))</span>
            <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span>
                      <span class="n">conv_stat</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;err != ERROR_OUT_OF_BOUNDS &quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)]))]</span>
        <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">While</span><span class="p">(</span><span class="s2">&quot;1==1&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">cstat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_NestedVectorFieldEvalNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">cstat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="n">ccode_eval</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">ccode_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var2</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">var3</span><span class="p">,</span>
                                        <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                                        <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">!=</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
                <span class="n">ccode_conv1</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">ccode_conv2</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">ccode_conv1</span><span class="p">)),</span>
                              <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var2</span><span class="p">,</span> <span class="n">ccode_conv2</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">ccode_conv3</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ccode_convert</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
                <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> *= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">var3</span><span class="p">,</span> <span class="n">ccode_conv3</span><span class="p">)))</span>
            <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">ccode_eval</span><span class="p">),</span>
                      <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">statements</span><span class="p">),</span>
                      <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;err != ERROR_OUT_OF_BOUNDS &quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)]))]</span>
        <span class="n">cstat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;CHECKERROR(err)&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">While</span><span class="p">(</span><span class="s2">&quot;1==1&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">cstat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;return </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;s&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;printf(&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">ccode</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;s_print&#39;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">ccode</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;printf(&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&quot;&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">ccode</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">int_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;particle-&gt;id&#39;</span><span class="p">,</span> <span class="s1">&#39;particle-&gt;xi&#39;</span><span class="p">,</span> <span class="s1">&#39;particle-&gt;yi&#39;</span><span class="p">,</span> <span class="s1">&#39;particle-&gt;zi&#39;</span><span class="p">]</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">ccode</span> <span class="ow">in</span> <span class="n">int_vars</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;printf(&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&quot;, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="nb">vars</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_Str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_isdocstr</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="c1"># Check if node is docstr. Comparison only on text, not whitespace etc</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">s</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]</span> <span class="o">==</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">docstr</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">docstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_isdocstr</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ccode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">s</span></div>


<div class="viewcode-block" id="LoopGenerator"><a class="viewcode-back" href="../../index.html#parcels.codegenerator.LoopGenerator">[docs]</a><span class="k">class</span> <span class="nc">LoopGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Code generator class that adds type definitions and the outer</span>
<span class="sd">    loop around kernel functions to generate compilable C code.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldset</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span> <span class="o">=</span> <span class="n">fieldset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ptype</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="n">const_args</span><span class="p">,</span> <span class="n">kernel_ast</span><span class="p">,</span> <span class="n">c_include</span><span class="p">):</span>
        <span class="n">ccode</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;p&#39;</span>

        <span class="c1"># ==== Add include for Parcels and math header ==== #</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="s2">&quot;parcels.h&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">False</span><span class="p">))]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="s2">&quot;math.h&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">False</span><span class="p">))]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s1">&#39;double _next_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s1">&#39;size_t _next_dt_set&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s1">&#39;const int ngrid&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="o">.</span><span class="n">gridset</span><span class="o">.</span><span class="n">size</span><span class="p">)))]</span>

        <span class="c1"># ==== Generate type definition for particle type ==== #</span>
        <span class="n">vdeclp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">POD</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Typedef</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GenerableStruct</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">vdeclp</span><span class="p">,</span> <span class="n">declname</span><span class="o">=</span><span class="n">pname</span><span class="p">)))]</span>
        <span class="c1"># Generate type definition for single particle type</span>
        <span class="n">vdecl</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POD</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">]</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Typedef</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GenerableStruct</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">vdecl</span><span class="p">,</span> <span class="n">declname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span><span class="p">)))]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;particle_backup&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="s2">&quot;particles&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)]</span>
        <span class="n">p_back_set_decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">DeclSpecifier</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;void&quot;</span><span class="p">,</span> <span class="s2">&quot;set_particle_backup&quot;</span><span class="p">),</span>
                                                         <span class="n">spec</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">)),</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]:</span>
                <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">((</span><span class="s2">&quot;particle_backup-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;particles-&gt;</span><span class="si">%s</span><span class="s2">[p]&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">))]</span>
        <span class="n">p_back_set_body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">p_back_set</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">p_back_set_decl</span><span class="p">,</span> <span class="n">p_back_set_body</span><span class="p">))</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p_back_set</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;particle_backup&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="s2">&quot;particles&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)]</span>
        <span class="n">p_back_get_decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">DeclSpecifier</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;void&quot;</span><span class="p">,</span> <span class="s2">&quot;get_particle_backup&quot;</span><span class="p">),</span>
                                                         <span class="n">spec</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">)),</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]:</span>
                <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">((</span><span class="s2">&quot;particles-&gt;</span><span class="si">%s</span><span class="s2">[p]&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;particle_backup-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">))]</span>
        <span class="n">p_back_get_body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">p_back_get</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">p_back_get_decl</span><span class="p">,</span> <span class="n">p_back_get_body</span><span class="p">))</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p_back_get</span><span class="p">]</span>

        <span class="n">update_next_dt_decl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">DeclSpecifier</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;void&quot;</span><span class="p">,</span> <span class="s2">&quot;update_next_dt&quot;</span><span class="p">),</span>
                                                             <span class="n">spec</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">)),</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="s1">&#39;update_next_dt&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">kernel_ast</span><span class="p">):</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;_next_dt&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">)]</span>
            <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;_next_dt_set&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)]</span>
            <span class="n">update_next_dt_body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">update_next_dt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">update_next_dt_decl</span><span class="p">,</span> <span class="n">update_next_dt_body</span><span class="p">))</span>
            <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="n">update_next_dt</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">c_include</span><span class="p">:</span>
            <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c_include</span><span class="p">]</span>

        <span class="c1"># ==== Insert kernel code ==== #</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">kernel_ast</span><span class="p">)]</span>

        <span class="c1"># Generate outer loop for repeated kernel invocation</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;num_particles&quot;</span><span class="p">),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="s2">&quot;particles&quot;</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;endtime&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">field_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;CField&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">const</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">const_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="n">const</span><span class="p">)]</span>
        <span class="n">fargs_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;particles-&gt;time[p]&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                              <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">const_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># ==== statement clusters use to compose &#39;body&#39; variable and variables &#39;time_loop&#39; and &#39;part_loop&#39; ==== ##</span>
        <span class="n">sign_dt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;sign_dt&quot;</span><span class="p">,</span> <span class="s2">&quot;dt &gt; 0 ? 1 : -1&quot;</span><span class="p">)</span>
        <span class="n">particle_backup</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> particle_backup&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">sign_end_part</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;sign_end_part&quot;</span><span class="p">,</span> <span class="s2">&quot;(endtime - particles-&gt;time[p]) &gt; 0 ? 1 : -1&quot;</span><span class="p">)</span>
        <span class="n">reset_res_state</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="s2">&quot;particles-&gt;state[p]&quot;</span><span class="p">)</span>
        <span class="n">update_state</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;particles-&gt;state[p]&quot;</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">)</span>
        <span class="n">update_pdt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;_next_dt_set == 1&quot;</span><span class="p">,</span>
                          <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;_next_dt_set&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;particles-&gt;dt[p]&quot;</span><span class="p">,</span> <span class="s2">&quot;_next_dt&quot;</span><span class="p">)]))</span>

        <span class="n">dt_pos</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;__dt&quot;</span><span class="p">,</span> <span class="s2">&quot;fmin(fabs(particles-&gt;dt[p]), fabs(endtime - particles-&gt;time[p]))&quot;</span><span class="p">)</span>                   <span class="c1"># original</span>

        <span class="n">pdt_eq_dt_pos</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;__pdt_prekernels&quot;</span><span class="p">,</span> <span class="s2">&quot;__dt * sign_dt&quot;</span><span class="p">)</span>
        <span class="n">partdt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;particles-&gt;dt[p]&quot;</span><span class="p">,</span> <span class="s2">&quot;__pdt_prekernels&quot;</span><span class="p">)</span>
        <span class="n">check_pdt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;(res == SUCCESS) &amp; !is_equal_dbl(__pdt_prekernels, particles-&gt;dt[p])&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="s2">&quot;REPEAT&quot;</span><span class="p">))</span>

        <span class="n">dt_0_break</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;is_zero_dbl(particles-&gt;dt[p])&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">))</span>

        <span class="n">notstarted_continue</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;(( sign_end_part != sign_dt) || is_close_dbl(__dt, 0) ) &amp;&amp; !is_zero_dbl(particles-&gt;dt[p])&quot;</span><span class="p">,</span>
                                   <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span>
                                       <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;fabs(particles-&gt;time[p]) &gt;= fabs(endtime)&quot;</span><span class="p">,</span>
                                            <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;particles-&gt;state[p]&quot;</span><span class="p">,</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">)),</span>
                                       <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;continue&quot;</span><span class="p">)</span>
                                   <span class="p">]))</span>

        <span class="c1"># ==== main computation body ==== #</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;set_particle_backup(&amp;particle_backup, particles, p)&quot;</span><span class="p">)]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pdt_eq_dt_pos</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">partdt</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;ErrorCode&quot;</span><span class="p">,</span> <span class="s2">&quot;state_prev&quot;</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;state_prev&quot;</span><span class="p">,</span> <span class="s2">&quot;particles-&gt;state[p]&quot;</span><span class="p">)]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(particles, p, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">fargs_str</span><span class="p">))]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;(res==SUCCESS) &amp;&amp; (particles-&gt;state[p] != state_prev)&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="s2">&quot;particles-&gt;state[p]&quot;</span><span class="p">))]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">check_pdt</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;res == SUCCESS || res == DELETE&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;particles-&gt;time[p] += particles-&gt;dt[p]&quot;</span><span class="p">),</span>
                                                                  <span class="n">update_pdt</span><span class="p">,</span>
                                                                  <span class="n">dt_pos</span><span class="p">,</span>
                                                                  <span class="n">sign_end_part</span><span class="p">,</span>
                                                                  <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;(res != DELETE) &amp;&amp; !is_close_dbl(__dt, 0) &amp;&amp; (sign_dt == sign_end_part)&quot;</span><span class="p">,</span>
                                                                       <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">)),</span>
                                                                  <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;sign_dt != sign_end_part&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;__dt&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                                                                  <span class="n">update_state</span><span class="p">,</span>
                                                                  <span class="n">dt_0_break</span>
                                                                  <span class="p">]),</span>
                      <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;get_particle_backup(&amp;particle_backup, particles, p)&quot;</span><span class="p">),</span>
                               <span class="n">dt_pos</span><span class="p">,</span>
                               <span class="n">sign_end_part</span><span class="p">,</span>
                               <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="s2">&quot;sign_dt != sign_end_part&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="s2">&quot;__dt&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                               <span class="n">update_state</span><span class="p">,</span>
                               <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)])</span>
                      <span class="p">)]</span>

        <span class="n">time_loop</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">While</span><span class="p">(</span><span class="s2">&quot;(particles-&gt;state[p] == EVALUATE || particles-&gt;state[p] == REPEAT) || is_zero_dbl(particles-&gt;dt[p])&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">part_loop</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">For</span><span class="p">(</span><span class="s2">&quot;p = 0&quot;</span><span class="p">,</span> <span class="s2">&quot;p &lt; num_particles&quot;</span><span class="p">,</span> <span class="s2">&quot;++p&quot;</span><span class="p">,</span>
                          <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">sign_end_part</span><span class="p">,</span> <span class="n">reset_res_state</span><span class="p">,</span> <span class="n">dt_pos</span><span class="p">,</span> <span class="n">notstarted_continue</span><span class="p">,</span> <span class="n">time_loop</span><span class="p">]))</span>
        <span class="n">fbody</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;p, sign_dt, sign_end_part&quot;</span><span class="p">),</span>
                         <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;ErrorCode&quot;</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">),</span>
                         <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;__pdt_prekernels&quot;</span><span class="p">),</span>
                         <span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;__dt&quot;</span><span class="p">),</span>  <span class="c1"># 1e-8 = built-in tolerance for np.isclose()</span>
                         <span class="n">sign_dt</span><span class="p">,</span> <span class="n">particle_backup</span><span class="p">,</span> <span class="n">part_loop</span><span class="p">])</span>
        <span class="n">fdecl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;void&quot;</span><span class="p">,</span> <span class="s2">&quot;particle_loop&quot;</span><span class="p">),</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">ccode</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">fdecl</span><span class="p">,</span> <span class="n">fbody</span><span class="p">))]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccode</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Parcels  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Michael Lange and Erik van Sebille.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.0.
    </div>
  </body>
</html>