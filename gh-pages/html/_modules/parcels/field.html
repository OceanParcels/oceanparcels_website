

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>parcels.field &#8212; Parcels  documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-96368922-1', 'auto');
  ga('send', 'pageview');
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Parcels  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/parcelslogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for parcels.field</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">c_float</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">c_int</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">POINTER</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">pointer</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">Structure</span>

<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">py</span> <span class="k">import</span> <span class="n">path</span>

<span class="kn">import</span> <span class="nn">parcels.tools.interpolation_utils</span> <span class="k">as</span> <span class="nn">i_u</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="k">import</span> <span class="n">CGrid</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="k">import</span> <span class="n">Grid</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="k">import</span> <span class="n">GridCode</span>
<span class="kn">from</span> <span class="nn">parcels.tools.converters</span> <span class="k">import</span> <span class="n">Geographic</span>
<span class="kn">from</span> <span class="nn">parcels.tools.converters</span> <span class="k">import</span> <span class="n">GeographicPolar</span>
<span class="kn">from</span> <span class="nn">parcels.tools.converters</span> <span class="k">import</span> <span class="n">TimeConverter</span>
<span class="kn">from</span> <span class="nn">parcels.tools.converters</span> <span class="k">import</span> <span class="n">UnitConverter</span>
<span class="kn">from</span> <span class="nn">parcels.tools.converters</span> <span class="k">import</span> <span class="n">unitconverters_map</span>
<span class="kn">from</span> <span class="nn">parcels.tools.error</span> <span class="k">import</span> <span class="n">FieldOutOfBoundError</span>
<span class="kn">from</span> <span class="nn">parcels.tools.error</span> <span class="k">import</span> <span class="n">FieldOutOfBoundSurfaceError</span>
<span class="kn">from</span> <span class="nn">parcels.tools.error</span> <span class="k">import</span> <span class="n">FieldSamplingError</span>
<span class="kn">from</span> <span class="nn">parcels.tools.error</span> <span class="k">import</span> <span class="n">TimeExtrapolationError</span>
<span class="kn">from</span> <span class="nn">parcels.tools.loggers</span> <span class="k">import</span> <span class="n">logger</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">,</span> <span class="s1">&#39;VectorField&#39;</span><span class="p">,</span> <span class="s1">&#39;SummedField&#39;</span><span class="p">,</span> <span class="s1">&#39;NestedField&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Field"><a class="viewcode-back" href="../../index.html#parcels.field.Field">[docs]</a><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that encapsulates access to field data.</span>

<span class="sd">    :param name: Name of the field</span>
<span class="sd">    :param data: 2D, 3D or 4D numpy array of field data.</span>

<span class="sd">           1. If data shape is [xdim, ydim], [xdim, ydim, zdim], [xdim, ydim, tdim] or [xdim, ydim, zdim, tdim],</span>
<span class="sd">              whichever is relevant for the dataset, use the flag transpose=True</span>
<span class="sd">           2. If data shape is [ydim, xdim], [zdim, ydim, xdim], [tdim, ydim, xdim] or [tdim, zdim, ydim, xdim],</span>
<span class="sd">              use the flag transpose=False</span>
<span class="sd">           3. If data has any other shape, you first need to reorder it</span>
<span class="sd">    :param lon: Longitude coordinates (numpy vector or array) of the field (only if grid is None)</span>
<span class="sd">    :param lat: Latitude coordinates (numpy vector or array) of the field (only if grid is None)</span>
<span class="sd">    :param depth: Depth coordinates (numpy vector or array) of the field (only if grid is None)</span>
<span class="sd">    :param time: Time coordinates (numpy vector) of the field (only if grid is None)</span>
<span class="sd">    :param mesh: String indicating the type of mesh coordinates and</span>
<span class="sd">           units used during velocity interpolation: (only if grid is None)</span>

<span class="sd">           1. spherical: Lat and lon in degree, with a</span>
<span class="sd">              correction for zonal velocity U near the poles.</span>
<span class="sd">           2. flat (default): No conversion, lat/lon are assumed to be in m.</span>
<span class="sd">    :param timestamps: A numpy array containing the timestamps for each of the files in filenames, for loading</span>
<span class="sd">           from netCDF files only. Default is None if the netCDF dimensions dictionary includes time.</span>
<span class="sd">    :param grid: :class:`parcels.grid.Grid` object containing all the lon, lat depth, time</span>
<span class="sd">           mesh and time_origin information. Can be constructed from any of the Grid objects</span>
<span class="sd">    :param fieldtype: Type of Field to be used for UnitConverter when using SummedFields</span>
<span class="sd">           (either &#39;U&#39;, &#39;V&#39;, &#39;Kh_zonal&#39;, &#39;Kh_meridional&#39; or None)</span>
<span class="sd">    :param transpose: Transpose data to required (lon, lat) layout</span>
<span class="sd">    :param vmin: Minimum allowed value on the field. Data below this value are set to zero</span>
<span class="sd">    :param vmax: Maximum allowed value on the field. Data above this value are set to zero</span>
<span class="sd">    :param time_origin: Time origin (TimeConverter object) of the time axis (only if grid is None)</span>
<span class="sd">    :param interp_method: Method for interpolation. Either &#39;linear&#39; or &#39;nearest&#39;</span>
<span class="sd">    :param allow_time_extrapolation: boolean whether to allow for extrapolation in time</span>
<span class="sd">           (i.e. beyond the last available time snapshot)</span>
<span class="sd">    :param time_periodic: To loop periodically over the time component of the Field. It is set to either False or the length of the period (either float in seconds or datetime.timedelta object).</span>
<span class="sd">           The last value of the time series can be provided (which is the same as the initial one) or not (Default: False)</span>
<span class="sd">           This flag overrides the allow_time_interpolation and sets it to False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fieldtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interp_method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">allow_time_extrapolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filebuffername</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filebuffername</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">time_origin</span> <span class="o">=</span> <span class="n">TimeConverter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">time_origin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">time_origin</span>
        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">create_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">time_origin</span><span class="o">=</span><span class="n">time_origin</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">igrid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># self.lon, self.lat, self.depth and self.time are not used anymore in parcels.</span>
        <span class="c1"># self.grid should be used instead.</span>
        <span class="c1"># Those variables are still defined for backwards compatibility with users codes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">fieldtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fieldtype</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unitconverters_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">UnitConverter</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">unitconverters_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldtype</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported mesh type. Choose either: &#39;spherical&#39; or &#39;flat&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check whether flattened or not</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stamp</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">timestamps</span> <span class="k">for</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">)</span> <span class="k">for</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp_method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">interp_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">=</span> <span class="n">interp_method</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;interp_method is a dictionary but </span><span class="si">%s</span><span class="s1"> is not in it&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">=</span> <span class="n">interp_method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">CurvilinearSGrid</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span><span class="s1">&#39;General s-levels are not supported in B-grid. RectilinearSGrid and CurvilinearSGrid can still be used to deal with shaved cells, but the levels must be horizontal.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">allow_time_extrapolation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span> <span class="o">=</span> <span class="n">allow_time_extrapolation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="o">=</span> <span class="n">time_periodic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span><span class="s2">&quot;allow_time_extrapolation and time_periodic cannot be used together.</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                 allow_time_extrapolation is set to False&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported time_periodic=True. time_periodic must now be either False or the length of the period (either float in seconds or datetime.timedelta object.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Time series provided is longer than the time_periodic parameter&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">_add_last_periodic_data_timestep</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">defer_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">transpose</span><span class="p">)</span>

            <span class="c1"># Hack around the fact that NaN and ridiculously large values</span>
            <span class="c1"># propagate in SciPy&#39;s interpolators</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">_add_last_periodic_data_timestep</span><span class="p">:</span>
                <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_factor</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Variable names in JIT code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dimensions&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dataFiles&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">_add_last_periodic_data_timestep</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;netcdf_engine&#39;</span><span class="p">,</span> <span class="s1">&#39;netcdf4&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_time_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_log</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;creation_log&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;field_chunksize&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>

        <span class="c1"># data_full_zdim is the vertical dimension of the complete field data, ignoring the indices.</span>
        <span class="c1"># (data_full_zdim = grid.zdim if no indices are used, for A- and C-grids and for some B-grids). It is used for the B-grid,</span>
        <span class="c1"># since some datasets do not provide the deeper level of data (which is ignored by the interpolation).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data_full_zdim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filebuffers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dim_filenames</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">filenames</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">filenames</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
                <span class="s1">&#39;filename dimension keys must be lon, lat, depth or data&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filenames</span>

<div class="viewcode-block" id="Field.from_netcdf"><a class="viewcode-back" href="../../index.html#parcels.field.Field.from_netcdf">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_netcdf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mesh</span><span class="o">=</span><span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_time_extrapolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">deferred_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">field_chunksize</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create field from netCDF file</span>

<span class="sd">        :param filenames: list of filenames to read for the field. filenames can be a list [files] or</span>
<span class="sd">               a dictionary {dim:[files]} (if lon, lat, depth and/or data not stored in same files as data)</span>
<span class="sd">               In the latetr case, time values are in filenames[data]</span>
<span class="sd">        :param variable: Tuple mapping field name to variable name in the NetCDF file.</span>
<span class="sd">        :param dimensions: Dictionary mapping variable names for the relevant dimensions in the NetCDF file</span>
<span class="sd">        :param indices: dictionary mapping indices for each dimension to read from file.</span>
<span class="sd">               This can be used for reading in only a subregion of the NetCDF file.</span>
<span class="sd">               Note that negative indices are not allowed.</span>
<span class="sd">        :param mesh: String indicating the type of mesh coordinates and</span>
<span class="sd">               units used during velocity interpolation:</span>

<span class="sd">               1. spherical (default): Lat and lon in degree, with a</span>
<span class="sd">                  correction for zonal velocity U near the poles.</span>
<span class="sd">               2. flat: No conversion, lat/lon are assumed to be in m.</span>
<span class="sd">        :param timestamps: A numpy array of datetime64 objects containing the timestamps for each of the files in filenames.</span>
<span class="sd">               Default is None if dimensions includes time.</span>
<span class="sd">        :param allow_time_extrapolation: boolean whether to allow for extrapolation in time</span>
<span class="sd">               (i.e. beyond the last available time snapshot)</span>
<span class="sd">               Default is False if dimensions includes time, else True</span>
<span class="sd">        :param time_periodic: boolean whether to loop periodically over the time component of the FieldSet</span>
<span class="sd">               This flag overrides the allow_time_interpolation and sets it to False</span>
<span class="sd">        :param deferred_load: boolean whether to only pre-load data (in deferred mode) or</span>
<span class="sd">               fully load them (default: True). It is advised to deferred load the data, since in</span>
<span class="sd">               that case Parcels deals with a better memory management during particle set execution.</span>
<span class="sd">               deferred_load=False is however sometimes necessary for plotting the fields.</span>
<span class="sd">        :param field_chunksize: size of the chunks in dask loading</span>
<span class="sd">        :param netcdf_engine: engine to use for netcdf reading in xarray. Default is &#39;netcdf&#39;,</span>
<span class="sd">               but in cases where this doesn&#39;t work, setting netcdf_engine=&#39;scipy&#39; could help</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure the timestamps array is compatible with the user-provided datafiles.</span>
        <span class="k">if</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">),</span> <span class="s1">&#39;Outer dimension of timestamps should correspond to number of files.&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">filenames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)),</span> <span class="s1">&#39;Outer dimension of timestamps should correspond to number of files.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Filenames type is inconsistent with manual timestamp provision.&quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;Should be dict or list&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dataarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">lonlat_filename</span> <span class="o">=</span> <span class="n">variable</span>
            <span class="n">depth_filename</span> <span class="o">=</span> <span class="n">variable</span>
            <span class="n">data_filenames</span> <span class="o">=</span> <span class="n">variable</span>
            <span class="n">netcdf_engine</span> <span class="o">=</span> <span class="s1">&#39;xarray&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># for backward compatibility with Parcels &lt; 2.0.0</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;The variable tuple must have length 2. Use FieldSet.from_netcdf() for multiple variables&#39;</span>

            <span class="n">data_filenames</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dim_filenames</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="n">lonlat_filename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dim_filenames</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lonlat_filename</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">lonlat_filename</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dim_filenames</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;longitude and latitude dimensions are currently processed together from one single file&#39;</span><span class="p">)</span>
            <span class="n">lonlat_filename</span> <span class="o">=</span> <span class="n">lonlat_filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
                <span class="n">depth_filename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dim_filenames</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth_filename</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Vertically adaptive meshes not implemented for from_netcdf()&#39;</span><span class="p">)</span>
                <span class="n">depth_filename</span> <span class="o">=</span> <span class="n">depth_filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">netcdf_engine</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;netcdf_engine&#39;</span><span class="p">,</span> <span class="s1">&#39;netcdf4&#39;</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">indices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> \
                <span class="p">(</span><span class="s1">&#39;Negative indices are currently not allowed in Parcels. &#39;</span>
                 <span class="o">+</span> <span class="s1">&#39;This is related to the non-increasing dimension it could generate &#39;</span>
                 <span class="o">+</span> <span class="s1">&#39;if the domain goes from lon[-4] to lon[6] for example. &#39;</span>
                 <span class="o">+</span> <span class="s1">&#39;Please raise an issue on https://github.com/OceanParcels/parcels/issues &#39;</span>
                 <span class="o">+</span> <span class="s1">&#39;if you would need such feature implemented.&#39;</span><span class="p">)</span>

        <span class="n">interp_method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;interp_method&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp_method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">interp_method</span><span class="p">:</span>
                <span class="n">interp_method</span> <span class="o">=</span> <span class="n">interp_method</span><span class="p">[</span><span class="n">variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;interp_method is a dictionary but </span><span class="si">%s</span><span class="s1"> is not in it&#39;</span> <span class="o">%</span> <span class="n">variable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="n">lonlat_filename</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">filebuffer</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">read_lonlat</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">indices</span>
            <span class="c1"># Check if parcels_mesh has been explicitly set in file</span>
            <span class="k">if</span> <span class="s1">&#39;parcels_mesh&#39;</span> <span class="ow">in</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">mesh</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;parcels_mesh&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="n">depth_filename</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">,</span> <span class="n">interp_method</span><span class="o">=</span><span class="n">interp_method</span><span class="p">)</span> <span class="k">as</span> <span class="n">filebuffer</span><span class="p">:</span>
                <span class="n">filebuffer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">parse_name</span><span class="p">(</span><span class="n">variable</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">read_depth</span>
                <span class="n">data_full_zdim</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">data_full_zdim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data_full_zdim</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_full_zdim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_full_zdim</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimensions</span> <span class="ow">and</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Multiple files given but no time dimension specified&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Concatenate time variable to determine overall dimension</span>
            <span class="c1"># across multiple files</span>
            <span class="k">if</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataFiles</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">findex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_filenames</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data_filenames</span><span class="p">[</span><span class="n">findex</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">findex</span><span class="p">]):</span>
                        <span class="n">dataFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stamp</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">timestamps</span> <span class="k">for</span> <span class="n">stamp</span> <span class="ow">in</span> <span class="n">file</span><span class="p">])</span>
                <span class="n">timeslices</span> <span class="o">=</span> <span class="n">timestamps</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">timeslices</span>
            <span class="k">elif</span> <span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="n">data_filenames</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">filebuffer</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">timeslices</span> <span class="o">=</span> <span class="n">time</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
                    <span class="n">dataFiles</span> <span class="o">=</span> <span class="n">data_filenames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_filenames</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">data_filenames</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeslices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dataFiles</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">data_filenames</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">,</span>
                                          <span class="n">field_chunksize</span><span class="o">=</span><span class="n">field_chunksize</span><span class="p">)</span> <span class="k">as</span> <span class="n">filebuffer</span><span class="p">:</span>
                        <span class="n">ftime</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">timeslices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ftime</span><span class="p">)</span>
                        <span class="n">dataFiles</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fname</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ftime</span><span class="p">))</span>
                <span class="n">timeslices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeslices</span><span class="p">)</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">timeslices</span><span class="p">)</span>
                <span class="n">dataFiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataFiles</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">time_origin</span> <span class="o">=</span> <span class="n">TimeConverter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time_origin</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">id_not_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Please make sure your netCDF files are ordered in time. First pair of non-ordered files: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">dataFiles</span><span class="p">[</span><span class="n">id_not_ordered</span><span class="p">],</span> <span class="n">dataFiles</span><span class="p">[</span><span class="n">id_not_ordered</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">create_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">time_origin</span><span class="o">=</span><span class="n">time_origin</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">timeslices</span> <span class="o">=</span> <span class="n">timeslices</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dataFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataFiles</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span><span class="s1">&#39;time dimension in indices is not necessary anymore. It is then ignored.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;full_load&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># for backward compatibility with Parcels &lt; v2.0.0</span>
            <span class="n">deferred_load</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;full_load&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">deferred_load</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Pre-allocate data before reading files into buffer</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ti</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tslice</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">timeslices</span><span class="p">,</span> <span class="n">data_filenames</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">,</span>
                                      <span class="n">interp_method</span><span class="o">=</span><span class="n">interp_method</span><span class="p">,</span> <span class="n">data_full_zdim</span><span class="o">=</span><span class="n">data_full_zdim</span><span class="p">,</span>
                                      <span class="n">field_chunksize</span><span class="o">=</span><span class="n">field_chunksize</span><span class="p">)</span> <span class="k">as</span> <span class="n">filebuffer</span><span class="p">:</span>
                    <span class="c1"># If Field.from_netcdf is called directly, it may not have a &#39;data&#39; dimension</span>
                    <span class="c1"># In that case, assume that &#39;name&#39; is the data dimension</span>
                    <span class="k">if</span> <span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
                        <span class="n">tslice</span> <span class="o">=</span> <span class="p">[</span><span class="n">tslice</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filebuffer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">parse_name</span><span class="p">(</span><span class="n">variable</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">sum</span><span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">tslice</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="p">())))</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filebuffer</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">sum</span><span class="p">(((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="p">())))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">sum</span><span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">tslice</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="p">())))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">)</span>
                <span class="n">ti</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tslice</span><span class="p">)</span>
            <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">defer_load</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DeferredArray</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">allow_time_extrapolation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allow_time_extrapolation</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">dimensions</span> <span class="k">else</span> <span class="kc">True</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dimensions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;time_periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_periodic</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;netcdf_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">netcdf_engine</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;field_chunksize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_chunksize</span>

        <span class="n">variable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span> <span class="k">else</span> <span class="n">variable</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span>
                   <span class="n">allow_time_extrapolation</span><span class="o">=</span><span class="n">allow_time_extrapolation</span><span class="p">,</span> <span class="n">interp_method</span><span class="o">=</span><span class="n">interp_method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Ensure that field data is the right data type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span><span class="s2">&quot;Casting field data to np.float32&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
        <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat_flipped</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">sum</span><span class="p">(((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">sum</span><span class="p">(((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">meridional_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zonal_halo</span><span class="p">),</span> \
                                 <span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1"> expecting a data shape of a [ydim, xdim], [zdim, ydim, xdim], [tdim, ydim, xdim] or [tdim, zdim, ydim, xdim]. Flag transpose=True could help to reorder the data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">meridional_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zonal_halo</span><span class="p">),</span> \
                                 <span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1"> expecting a data shape of a [ydim, xdim], [zdim, ydim, xdim], [tdim, ydim, xdim] or [tdim, zdim, ydim, xdim]. Flag transpose=True could help to reorder the data.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">meridional_halo</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zonal_halo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_periodic_halo</span><span class="p">(</span><span class="n">zonal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zonal_halo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">meridional_halo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">halosize</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">meridional_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zonal_halo</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="Field.set_scaling_factor"><a class="viewcode-back" href="../../index.html#parcels.field.Field.set_scaling_factor">[docs]</a>    <span class="k">def</span> <span class="nf">set_scaling_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scales the field data by some constant factor.</span>

<span class="sd">        :param factor: scaling factor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_factor</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">((</span><span class="s1">&#39;Scaling factor for field </span><span class="si">%s</span><span class="s1"> already defined.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_factor</span> <span class="o">=</span> <span class="n">factor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">defer_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">factor</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="Field.calc_cell_edge_sizes"><a class="viewcode-back" href="../../index.html#parcels.field.Field.calc_cell_edge_sizes">[docs]</a>    <span class="k">def</span> <span class="nf">calc_cell_edge_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to calculate cell sizes based on numpy.gradient method</span>
<span class="sd">                Currently only works for Rectilinear Grids&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="n">x_conv</span> <span class="o">=</span> <span class="n">GeographicPolar</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span> <span class="k">else</span> <span class="n">UnitConverter</span><span class="p">()</span>
                <span class="n">y_conv</span> <span class="o">=</span> <span class="n">Geographic</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span> <span class="k">else</span> <span class="n">UnitConverter</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">))):</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">))):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_conv</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_conv</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_edge_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">((</span><span class="s1">&#39;Field.cell_edge_sizes() not implemented for &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span><span class="p">,</span> <span class="s1">&#39;grids.&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;You can provide Field.grid.cell_edge_sizes yourself&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;by in e.g. NEMO using the e1u fields etc from the mesh_mask.nc file&#39;</span><span class="p">))</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Field.cell_areas"><a class="viewcode-back" href="../../index.html#parcels.field.Field.cell_areas">[docs]</a>    <span class="k">def</span> <span class="nf">cell_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to calculate cell sizes based on cell_edge_sizes</span>
<span class="sd">                Currently only works for Rectilinear Grids&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_cell_edge_sizes</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_edge_sizes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">search_indices_vertical_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundSurfaceError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">depth_index</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="n">z</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">depth_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search_indices_vertical_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]:</span>
            <span class="n">xsi</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]:</span>
            <span class="n">ti</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">z4d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ti</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">depth_vector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dv2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">ti</span><span class="p">:</span><span class="n">ti</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">ti</span><span class="p">:</span><span class="n">ti</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">ti</span><span class="p">:</span><span class="n">ti</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">ti</span><span class="p">:</span><span class="n">ti</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tt</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Vertical s grid is being wrongly interpolated in time&#39;</span>
                <span class="n">depth_vector</span> <span class="o">=</span> <span class="n">dv2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tt</span><span class="p">)</span> <span class="o">+</span> <span class="n">dv2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth_vector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[:,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[:,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">depth_index</span> <span class="o">=</span> <span class="n">depth_vector</span> <span class="o">&lt;=</span> <span class="n">z</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">depth_vector</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth_vector</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">depth_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">depth_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">depth_vector</span><span class="p">[</span><span class="n">zi</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundSurfaceError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">depth_vector</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">depth_vector</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">depth_vector</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">depth_vector</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reconnect_bnd_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">sphere_mesh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sphere_mesh</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sphere_mesh</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">yi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">yi</span> <span class="o">&gt;</span> <span class="n">ydim</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="n">ydim</span><span class="o">-</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">sphere_mesh</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">xdim</span> <span class="o">-</span> <span class="n">xi</span>
        <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span>

    <span class="k">def</span> <span class="nf">search_indices_rectilinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ti</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">search2D</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">yi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">grid</span><span class="o">.</span><span class="n">zonal_periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">!=</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
            <span class="n">lon_index</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">xsi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon_fixed</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">lon_fixed</span> <span class="o">&gt;=</span> <span class="n">lon_fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">indices</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">lon_fixed</span><span class="p">[</span><span class="n">indices</span><span class="o">.</span><span class="n">argmin</span><span class="p">():]</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">lon_fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">lon_fixed</span> <span class="o">-=</span> <span class="mi">360</span>

            <span class="n">lon_index</span> <span class="o">=</span> <span class="n">lon_fixed</span> <span class="o">&lt;</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_fixed</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">lon_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">xsi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lon_fixed</span><span class="p">[</span><span class="n">xi</span><span class="p">])</span>

        <span class="n">lat_index</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">lat_index</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="n">lat_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">lat_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">eta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">zdim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search2D</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">:</span>
                <span class="c1"># Never passes here, because in this case, we work with scipy</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_vertical_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldOutOfBoundError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldOutOfBoundSurfaceError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldOutOfBoundSurfaceError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">:</span>
                <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_vertical_s</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xsi</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">eta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">zeta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">FieldSamplingError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search_indices_curvilinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">search2D</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">xsi</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">invA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">maxIterSearch</span> <span class="o">=</span> <span class="mf">1e6</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">grid</span><span class="o">.</span><span class="n">zonal_periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># This prevents from crashing in [160, -160]</span>
                    <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">lonlat_minmax</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">xsi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">xsi</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">eta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">eta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
                <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">-</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">+</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">-</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invA</span><span class="p">,</span> <span class="n">px</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invA</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span>

            <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>  <span class="c1"># Rectilinear cell, or quasi</span>
                <span class="n">eta</span> <span class="o">=</span> <span class="o">-</span><span class="n">cc</span> <span class="o">/</span> <span class="n">bb</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">det2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">*</span><span class="n">bb</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">aa</span><span class="o">*</span><span class="n">cc</span>
                <span class="k">if</span> <span class="n">det2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># so, if det is nan we keep the xsi, eta from previous iter</span>
                    <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">det2</span><span class="p">)</span>
                    <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">bb</span><span class="o">+</span><span class="n">det</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">aa</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>  <span class="c1"># this happens when recti cell rotated of 90deg</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">eta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">xi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">yi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">eta</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">xi</span> <span class="o">==</span> <span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">yi</span> <span class="o">==</span> <span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">xsi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">eta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">yi</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">eta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">yi</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_bnd_indices</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">maxIterSearch</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correct cell not found after </span><span class="si">%d</span><span class="s1"> iterations&#39;</span> <span class="o">%</span> <span class="n">maxIterSearch</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">zdim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search2D</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">CurvilinearZGrid</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_vertical_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldOutOfBoundError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">CurvilinearSGrid</span><span class="p">:</span>
                <span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_vertical_s</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xsi</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">eta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">zeta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">FieldSamplingError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">search2D</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_rectilinear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">search2D</span><span class="o">=</span><span class="n">search2D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices_curvilinear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">search2D</span><span class="o">=</span><span class="n">search2D</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolator2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="n">xii</span> <span class="o">=</span> <span class="n">xi</span> <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">else</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">yii</span> <span class="o">=</span> <span class="n">yi</span> <span class="k">if</span> <span class="n">eta</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">else</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yii</span><span class="p">,</span> <span class="n">xii</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cgrid_tracer&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is a scalar field. cgrid_velocity interpolation method should be used for vector fields (e.g. FieldSet.UV)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span><span class="o">+</span><span class="s2">&quot; is not implemented for 2D grids&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolator3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="n">xii</span> <span class="o">=</span> <span class="n">xi</span> <span class="k">if</span> <span class="n">xsi</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">else</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">yii</span> <span class="o">=</span> <span class="n">yi</span> <span class="k">if</span> <span class="n">eta</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">else</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">zii</span> <span class="o">=</span> <span class="n">zi</span> <span class="k">if</span> <span class="n">zeta</span> <span class="o">&lt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">else</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zii</span><span class="p">,</span> <span class="n">yii</span><span class="p">,</span> <span class="n">xii</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
            <span class="c1"># evaluating W velocity in c_grid</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">zeta</span><span class="p">)</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">+</span> <span class="n">zeta</span> <span class="o">*</span> <span class="n">f1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">:</span>
                <span class="n">zeta</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">:</span>
                <span class="n">eta</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">xsi</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">zeta</span><span class="p">)</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">+</span> <span class="n">zeta</span> <span class="o">*</span> <span class="n">f1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cgrid_tracer&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span><span class="o">+</span><span class="s2">&quot; is not implemented for 3D grids&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Field.temporal_interpolate_fullfield"><a class="viewcode-back" href="../../index.html#parcels.field.Field.temporal_interpolate_fullfield">[docs]</a>    <span class="k">def</span> <span class="nf">temporal_interpolate_fullfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the data of a field between two snapshots,</span>
<span class="sd">        using linear interpolation</span>

<span class="sd">        :param ti: Index in time array associated with time (via :func:`time_index`)</span>
<span class="sd">        :param time: Time to interpolate to</span>

<span class="sd">        :rtype: Linearly interpolated field&quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="n">t0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">ti</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TimeExtrapolationError</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;show_time&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">return</span> <span class="n">f0</span> <span class="o">+</span> <span class="p">(</span><span class="n">f1</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span></div>

<div class="viewcode-block" id="Field.spatial_interpolation"><a class="viewcode-back" href="../../index.html#parcels.field.Field.spatial_interpolation">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate horizontal field values using a SciPy interpolator&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolator2D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolator3D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="c1"># Detect Out-of-bounds sampling and raise exception</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Field.time_index"><a class="viewcode-back" href="../../index.html#parcels.field.Field.time_index">[docs]</a>    <span class="k">def</span> <span class="nf">time_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the index in the time array associated with a given time</span>

<span class="sd">        Note that we normalize to either the first or the last index</span>
<span class="sd">        if the sampled value is outside the time value range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">TimeExtrapolationError</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">time_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_index</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">time_index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">periods</span><span class="p">,</span> <span class="n">c_int</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">periods</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">periods</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">periods</span> <span class="o">=</span> <span class="n">periods</span>
                <span class="n">time</span> <span class="o">-=</span> <span class="n">periods</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">time_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">time</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="n">time_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">time_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">time_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">time_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_index</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1"># If given time &gt; last known field time, use</span>
            <span class="c1"># the last field frame without interpolation</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">time_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">time_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Field.depth_index"><a class="viewcode-back" href="../../index.html#parcels.field.Field.depth_index">[docs]</a>    <span class="k">def</span> <span class="nf">depth_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the index in the depth array associated with a given depth&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">FieldOutOfBoundError</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">depth_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="n">depth</span>
        <span class="k">if</span> <span class="n">depth_index</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1"># If given depth == largest field depth, use the second-last</span>
            <span class="c1"># field depth (as zidx+1 needed in interpolation)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">depth_index</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">depth_index</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Field.eval"><a class="viewcode-back" href="../../index.html#parcels.field.Field.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">applyConversion</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate field values in space and time.</span>

<span class="sd">        We interpolate linearly in time and apply implicit unit</span>
<span class="sd">        conversion to the result. Note that we defer to</span>
<span class="sd">        scipy.interpolate to perform spatial interpolation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_index</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">-=</span> <span class="n">periods</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_interpolation</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_interpolation</span><span class="p">(</span><span class="n">ti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">+</span> <span class="p">(</span><span class="n">f1</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Skip temporal interpolation if time is outside</span>
            <span class="c1"># of the defined time range or if we have hit an</span>
            <span class="c1"># excat value in the time array.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_interpolation</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">applyConversion</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_target</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">ccode_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Casting interp_methd to int as easier to pass on in C-code</span>
        <span class="k">return</span> <span class="s2">&quot;temporal_interpolation(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, particle-&gt;cxi, particle-&gt;cyi, particle-&gt;czi, particle-&gt;cti, &amp;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">ccode_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">ccode_to_target</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_block_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">chunk_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numblocks</span>
            <span class="n">npartitions</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">npartitions</span> <span class="o">*=</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">t</span><span class="p">,)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">npartitions</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">npartitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">npartitions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npartitions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_int</span><span class="p">)</span>

        <span class="c1"># self.grid.chunk_info format: number of dimensions (without tdim); number of chunks per dimensions;</span>
        <span class="c1">#                         chunksizes (the 0th dim sizes for all chunk of dim[0], then so on for next dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">chunk_info</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span> <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="p">[])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">chunk_info</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">chunk_info</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_set</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">chunk_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunk_setup</span><span class="p">()</span>
        <span class="c1"># self.grid.load_chunk code:</span>
        <span class="c1"># 0: not loaded</span>
        <span class="c1"># 1: was asked to load by kernel in JIT</span>
        <span class="c1"># 2: is loaded and was touched last C call</span>
        <span class="c1"># 3: is loaded</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">block_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">blocks</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="p">),)</span><span class="o">+</span><span class="n">block</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ctypes_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a ctypes struct object containing all relevant</span>
<span class="sd">        pointers and sizes for this field.&quot;&quot;&quot;</span>

        <span class="c1"># Ctypes struct corresponding to the type definition in parcels.h</span>
        <span class="k">class</span> <span class="nc">CField</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;xdim&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ydim&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;zdim&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;tdim&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;igrid&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;allow_time_extrapolation&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;time_periodic&#39;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;data_chunks&#39;</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">c_float</span><span class="p">)))),</span>
                        <span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">CGrid</span><span class="p">))]</span>

        <span class="c1"># Create and populate the c-struct object</span>
        <span class="n">allow_time_extrapolation</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_time_extrapolation</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">time_periodic</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_periodic</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data_chunks should have been loaded by now if requested. grid.load_chunk[bid] cannot be 1&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">c_contiguous</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">c_float</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cstruct</span> <span class="o">=</span> <span class="n">CField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zdim</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrid</span><span class="p">,</span> <span class="n">allow_time_extrapolation</span><span class="p">,</span> <span class="n">time_periodic</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">c_float</span><span class="p">))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span><span class="p">))(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c_data_chunks</span><span class="p">),</span>
                         <span class="n">pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ctypes_struct</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cstruct</span>

<div class="viewcode-block" id="Field.show"><a class="viewcode-back" href="../../index.html#parcels.field.Field.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to &#39;show&#39; a Parcels Field</span>

<span class="sd">        :param animation: Boolean whether result is a single plot, or an animation</span>
<span class="sd">        :param show_time: Time at which to show the Field (only in single-plot mode)</span>
<span class="sd">        :param domain: dictionary (with keys &#39;N&#39;, &#39;S&#39;, &#39;E&#39;, &#39;W&#39;) defining domain to show</span>
<span class="sd">        :param depth_level: depth level to be plotted (default 0)</span>
<span class="sd">        :param projection: type of cartopy projection to use (default PlateCarree)</span>
<span class="sd">        :param land: Boolean whether to show land. This is ignored for flat meshes</span>
<span class="sd">        :param vmin: minimum colour scale (only in single-plot mode)</span>
<span class="sd">        :param vmax: maximum colour scale (only in single-plot mode)</span>
<span class="sd">        :param savefile: Name of a file to save the plot to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parcels.plotting</span> <span class="k">import</span> <span class="n">plotfield</span>
        <span class="n">plt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plotfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation</span><span class="o">=</span><span class="n">animation</span><span class="p">,</span> <span class="n">show_time</span><span class="o">=</span><span class="n">show_time</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">depth_level</span><span class="o">=</span><span class="n">depth_level</span><span class="p">,</span>
                                 <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="n">land</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="n">savefile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plt</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Field.add_periodic_halo"><a class="viewcode-back" href="../../index.html#parcels.field.Field.add_periodic_halo">[docs]</a>    <span class="k">def</span> <span class="nf">add_periodic_halo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zonal</span><span class="p">,</span> <span class="n">meridional</span><span class="p">,</span> <span class="n">halosize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a &#39;halo&#39; to all Fields in a FieldSet, through extending the Field (and lon/lat)</span>
<span class="sd">        by copying a small portion of the field on one side of the domain to the other.</span>
<span class="sd">        Before adding a periodic halo to the Field, it has to be added to the Grid on which the Field depends</span>

<span class="sd">        :param zonal: Create a halo in zonal direction (boolean)</span>
<span class="sd">        :param meridional: Create a halo in meridional direction (boolean)</span>
<span class="sd">        :param halosize: size of the halo (in grid points). Default is 5 grid points</span>
<span class="sd">        :param data: if data is not None, the periodic halo will be achieved on data instead of self.data and data will be returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataNone</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">defer_load</span> <span class="ow">and</span> <span class="n">dataNone</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">dataNone</span> <span class="k">else</span> <span class="n">data</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
        <span class="k">if</span> <span class="n">zonal</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">halosize</span><span class="p">:],</span> <span class="n">data</span><span class="p">,</span>
                                       <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">halosize</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="s2">&quot;Third dim must be x.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">halosize</span><span class="p">:],</span> <span class="n">data</span><span class="p">,</span>
                                       <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">halosize</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="s2">&quot;Fourth dim must be x.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="n">halosize</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">data</span><span class="p">,</span>
                                       <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">halosize</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="s2">&quot;Second dim must be y.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">halosize</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">data</span><span class="p">,</span>
                                       <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">halosize</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="s2">&quot;Third dim must be y.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span>
        <span class="k">if</span> <span class="n">dataNone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Field.write"><a class="viewcode-back" href="../../index.html#parcels.field.Field.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a :class:`Field` to a netcdf file</span>

<span class="sd">        :param filename: Basename of the file</span>
<span class="sd">        :param varname: Name of the field, to be appended to the filename&quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">.nc&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Derive name of &#39;depth&#39; variable for NEMO convention</span>
        <span class="n">vname_depth</span> <span class="o">=</span> <span class="s1">&#39;depth</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Create DataArray objects for file I/O</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">:</span>
            <span class="n">nav_lon</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                   <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">)])</span>
            <span class="n">nav_lat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                   <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="o">==</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">CurvilinearZGrid</span><span class="p">:</span>
            <span class="n">nav_lon</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">)),</span>
                                                          <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">))])</span>
            <span class="n">nav_lat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">)),</span>
                                                          <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Field.write only implemented for RectilinearZGrid and CurvilinearZGrid&#39;</span><span class="p">)</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;seconds since &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_origin</span><span class="p">)}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time_origin</span><span class="o">.</span><span class="n">calendar</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">time_counter</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                                    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time_counter&#39;</span><span class="p">],</span>
                                    <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">vardata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span><span class="p">)),</span>
                               <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time_counter&#39;</span><span class="p">,</span> <span class="n">vname_depth</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="c1"># Create xarray Dataset and output to netCDF format</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;parcels_mesh&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">}</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">varname</span><span class="p">:</span> <span class="n">vardata</span><span class="p">},</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nav_lon&#39;</span><span class="p">:</span> <span class="n">nav_lon</span><span class="p">,</span>
                                                      <span class="s1">&#39;nav_lat&#39;</span><span class="p">:</span> <span class="n">nav_lat</span><span class="p">,</span>
                                                      <span class="s1">&#39;time_counter&#39;</span><span class="p">:</span> <span class="n">time_counter</span><span class="p">,</span>
                                                      <span class="n">vname_depth</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">},</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">rescale_and_set_minmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_factor</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">data_concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_to_concat</span><span class="p">,</span> <span class="n">tindex</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_concat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
        <span class="k">if</span> <span class="n">tindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_to_concat</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">tindex</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tindex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">[:</span><span class="n">tindex</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data_to_concat</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">tindex</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tindex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">[:</span><span class="n">tindex</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data_to_concat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data_concatenate is used for computeTimeChunk, with tindex in [0, 1, 2]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">advancetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_new</span><span class="p">,</span> <span class="n">advanceForward</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">advanceForward</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># forward in time, so appending at end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">field_new</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># backward in time, so prepending at start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">field_new</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">time</span>

    <span class="k">def</span> <span class="nf">computeTimeChunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tindex</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span>
        <span class="n">filebuffer</span> <span class="o">=</span> <span class="n">NetcdfFileBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFiles</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">ti</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                      <span class="n">interp_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span><span class="p">,</span>
                                      <span class="n">data_full_zdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span><span class="p">,</span>
                                      <span class="n">field_chunksize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span><span class="p">)</span>
        <span class="n">filebuffer</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="n">time_data</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">time</span>
        <span class="n">time_data</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">time_origin</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">time_data</span><span class="p">)</span>
        <span class="n">filebuffer</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_data</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">tindex</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">!=</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
            <span class="n">filebuffer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">parse_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filebuffername</span><span class="p">)</span>
        <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">filebuffer</span><span class="o">.</span><span class="n">data</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">da</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="p">()))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">zdim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="p">()))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">buffer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="p">()))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buffer_data</span><span class="p">,</span> <span class="n">tindex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filebuffers</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">filebuffer</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SummedField</span><span class="p">(</span><span class="s1">&#39;_SummedField&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">SummedField</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="s1">&#39;Fields in a SummedField should be either all scalars or all vectors&#39;</span>
            <span class="n">field</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">field</span></div>


<div class="viewcode-block" id="VectorField"><a class="viewcode-back" href="../../index.html#parcels.field.VectorField">[docs]</a><span class="k">class</span> <span class="nc">VectorField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class VectorField stores 2 or 3 fields which defines together a vector field.</span>
<span class="sd">    This enables to interpolate them as one single vector field in the kernels.</span>

<span class="sd">    :param name: Name of the vector field</span>
<span class="sd">    :param U: field defining the zonal component</span>
<span class="sd">    :param V: field defining the meridional component</span>
<span class="sd">    :param W: field defining the vertical component (default: None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">=</span> <span class="s1">&#39;3D&#39;</span> <span class="k">if</span> <span class="n">W</span> <span class="k">else</span> <span class="s1">&#39;2D&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;Interpolation methods of U and V are not the same.&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;Grids of U and V are not the same.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s1">&#39;Interpolation methods of U and W are not the same.&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s1">&#39;Grids of U and W are not the same.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
            <span class="n">deg2m</span> <span class="o">=</span> <span class="mi">1852</span> <span class="o">*</span> <span class="mf">60.</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span><span class="p">)</span><span class="o">*</span><span class="n">deg2m</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span> <span class="o">*</span> <span class="n">lat</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">*</span><span class="n">deg2m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">):</span>
        <span class="n">dphidxsi</span> <span class="o">=</span> <span class="p">[</span><span class="n">eta</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">eta</span><span class="p">]</span>
        <span class="n">dphideta</span> <span class="o">=</span> <span class="p">[</span><span class="n">xsi</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">xsi</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">]</span>

        <span class="n">dxdxsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">dphidxsi</span><span class="p">)</span>
        <span class="n">dxdeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">dphideta</span><span class="p">)</span>
        <span class="n">dydxsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="n">dphidxsi</span><span class="p">)</span>
        <span class="n">dydeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="n">dphideta</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">dxdxsi</span><span class="o">*</span><span class="n">dydeta</span> <span class="o">-</span> <span class="n">dxdeta</span><span class="o">*</span><span class="n">dydxsi</span>
        <span class="k">return</span> <span class="n">jac</span>

    <span class="k">def</span> <span class="nf">spatial_c_grid_interpolation2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">search_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">]:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">]])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">-</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">+</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">-</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi2D_lin</span><span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">py</span><span class="p">))</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi2D_lin</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">py</span><span class="p">))</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi2D_lin</span><span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">py</span><span class="p">))</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi2D_lin</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">py</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">zdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">U0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">*</span> <span class="n">c4</span>
            <span class="n">U1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c2</span>
            <span class="n">V0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1</span>
            <span class="n">V1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">*</span> <span class="n">c4</span>
            <span class="n">U1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c2</span>
            <span class="n">V0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1</span>
            <span class="n">V1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c3</span>
        <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span> <span class="o">*</span> <span class="n">U0</span> <span class="o">+</span> <span class="n">xsi</span> <span class="o">*</span> <span class="n">U1</span>
        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">V0</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">V1</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        <span class="n">deg2m</span> <span class="o">=</span> <span class="mi">1852</span> <span class="o">*</span> <span class="mf">60.</span>
        <span class="n">meshJac</span> <span class="o">=</span> <span class="p">(</span><span class="n">deg2m</span> <span class="o">*</span> <span class="n">deg2m</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span> <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">*</span> <span class="n">meshJac</span>

        <span class="n">u</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span> <span class="o">-</span> <span class="n">xsi</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="n">U</span> <span class="o">+</span> <span class="n">xsi</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">eta</span> <span class="o">*</span> <span class="n">U</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">jac</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span> <span class="o">-</span> <span class="n">xsi</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="n">U</span> <span class="o">+</span> <span class="n">xsi</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
             <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">eta</span> <span class="o">*</span> <span class="n">U</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">jac</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spatial_c_grid_interpolation3D_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">search_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearZGrid</span><span class="p">]:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">xi</span><span class="p">]])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">-</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">360</span> <span class="k">if</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">+</span><span class="mi">225</span> <span class="k">else</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">-</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="mi">360</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xsi</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>

        <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">))</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">z4d</span><span class="p">:</span>
            <span class="n">pz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span>
                           <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span>
                           <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]])</span>

        <span class="n">u0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">zi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">U0</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">U1</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">V0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">V1</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">W0</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">W1</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="c1"># Computing fluxes in half left hexahedron -&gt; flux_u05</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="p">[</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">py</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">[</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pz</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pz</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
        <span class="n">flux_u0</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v0_halfx</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v1_halfx</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w0_halfx</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w1_halfx</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_u05</span> <span class="o">=</span> <span class="n">flux_u0</span> <span class="o">+</span> <span class="n">flux_v0_halfx</span> <span class="o">-</span> <span class="n">flux_v1_halfx</span> <span class="o">+</span> <span class="n">flux_w0_halfx</span> <span class="o">-</span> <span class="n">flux_w1_halfx</span>

        <span class="c1"># Computing fluxes in half front hexahedron -&gt; flux_v05</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">px</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="p">[</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">py</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">[</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pz</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">flux_u0_halfy</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_u1_halfy</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w0_halfy</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w1_halfy</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v05</span> <span class="o">=</span> <span class="n">flux_u0_halfy</span> <span class="o">-</span> <span class="n">flux_u1_halfy</span> <span class="o">+</span> <span class="n">flux_v0</span> <span class="o">+</span> <span class="n">flux_w0_halfy</span> <span class="o">-</span> <span class="n">flux_w1_halfy</span>

        <span class="c1"># Computing fluxes in half lower hexahedron -&gt; flux_w05</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">px</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="p">[</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">py</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">[</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pz</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pz</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">pz</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">flux_u0_halfz</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_u1_halfz</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v0_halfz</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_v1_halfz</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w0</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">flux_w05</span> <span class="o">=</span> <span class="n">flux_u0_halfz</span> <span class="o">-</span> <span class="n">flux_u1_halfz</span> <span class="o">+</span> <span class="n">flux_v0_halfz</span> <span class="o">-</span> <span class="n">flux_v1_halfz</span> <span class="o">+</span> <span class="n">flux_w0</span>

        <span class="n">surf_u05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">jac_u05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;zonal&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">U05</span> <span class="o">=</span> <span class="n">flux_u05</span> <span class="o">/</span> <span class="n">surf_u05</span> <span class="o">*</span> <span class="n">jac_u05</span>

        <span class="n">surf_v05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">jac_v05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="s1">&#39;meridional&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">V05</span> <span class="o">=</span> <span class="n">flux_v05</span> <span class="o">/</span> <span class="n">surf_v05</span> <span class="o">*</span> <span class="n">jac_v05</span>

        <span class="n">surf_w05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">jac_w05</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin_face</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">W05</span> <span class="o">=</span> <span class="n">flux_w05</span> <span class="o">/</span> <span class="n">surf_w05</span> <span class="o">*</span> <span class="n">jac_w05</span>

        <span class="n">jac</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">jacobian3D_lin</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">dxsidt</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi1D_quad</span><span class="p">,</span> <span class="p">[</span><span class="n">U0</span><span class="p">,</span> <span class="n">U05</span><span class="p">,</span> <span class="n">U1</span><span class="p">],</span> <span class="n">xsi</span><span class="p">)</span> <span class="o">/</span> <span class="n">jac</span>
        <span class="n">detadt</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi1D_quad</span><span class="p">,</span> <span class="p">[</span><span class="n">V0</span><span class="p">,</span> <span class="n">V05</span><span class="p">,</span> <span class="n">V1</span><span class="p">],</span> <span class="n">eta</span><span class="p">)</span> <span class="o">/</span> <span class="n">jac</span>
        <span class="n">dzetdt</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">i_u</span><span class="o">.</span><span class="n">phi1D_quad</span><span class="p">,</span> <span class="p">[</span><span class="n">W0</span><span class="p">,</span> <span class="n">W05</span><span class="p">,</span> <span class="n">W1</span><span class="p">],</span> <span class="n">zet</span><span class="p">)</span> <span class="o">/</span> <span class="n">jac</span>

        <span class="n">dphidxsi</span><span class="p">,</span> <span class="n">dphideta</span><span class="p">,</span> <span class="n">dphidzet</span> <span class="o">=</span> <span class="n">i_u</span><span class="o">.</span><span class="n">dphidxsi3D_lin</span><span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zet</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidxsi</span><span class="p">,</span> <span class="n">px</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxsidt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphideta</span><span class="p">,</span> <span class="n">px</span><span class="p">)</span> <span class="o">*</span> <span class="n">detadt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidzet</span><span class="p">,</span> <span class="n">px</span><span class="p">)</span> <span class="o">*</span> <span class="n">dzetdt</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidxsi</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxsidt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphideta</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">*</span> <span class="n">detadt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidzet</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">*</span> <span class="n">dzetdt</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidxsi</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxsidt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphideta</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span> <span class="o">*</span> <span class="n">detadt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dphidzet</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span> <span class="o">*</span> <span class="n">dzetdt</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

<div class="viewcode-block" id="VectorField.spatial_c_grid_interpolation3D"><a class="viewcode-back" href="../../index.html#parcels.field.VectorField.spatial_c_grid_interpolation3D">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_c_grid_interpolation3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          __ V1 __</span>
<span class="sd">        |          |</span>
<span class="sd">        U0         U1</span>
<span class="sd">        | __ V0 __ |</span>
<span class="sd">        The interpolation is done in the following by</span>
<span class="sd">        interpolating linearly U depending on the longitude coordinate and</span>
<span class="sd">        interpolating linearly V depending on the latitude coordinate.</span>
<span class="sd">        Curvilinear grids are treated properly, since the element is projected to a rectilinear parent element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GridCode</span><span class="o">.</span><span class="n">RectilinearSGrid</span><span class="p">,</span> <span class="n">GridCode</span><span class="o">.</span><span class="n">CurvilinearSGrid</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation3D_full</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation2D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_target</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">!=</span> <span class="s1">&#39;cgrid_velocity&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_target</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_target</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_target</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">grid</span>
            <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">time_index</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">-=</span> <span class="n">periods</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">time_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">tdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]:</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation3D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation3D</span><span class="p">(</span><span class="n">ti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">+</span> <span class="p">(</span><span class="n">w1</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation2D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation2D</span><span class="p">(</span><span class="n">ti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">+</span> <span class="p">(</span><span class="n">u1</span> <span class="o">-</span> <span class="n">u0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Skip temporal interpolation if time is outside</span>
                <span class="c1"># of the defined time range or if we have hit an</span>
                <span class="c1"># excat value in the time array.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation3D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_c_grid_interpolation2D</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ccode_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varU</span><span class="p">,</span> <span class="n">varV</span><span class="p">,</span> <span class="n">varW</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Casting interp_methd to int as easier to pass on in C-code</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;temporal_interpolationUVW(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, &quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="s2">&quot;particle-&gt;cxi, particle-&gt;cyi, particle-&gt;czi, particle-&gt;cti, &amp;</span><span class="si">%s</span><span class="s2">, &amp;</span><span class="si">%s</span><span class="s2">, &amp;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">varU</span><span class="p">,</span> <span class="n">varV</span><span class="p">,</span> <span class="n">varW</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">interp_method</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;temporal_interpolationUV(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, &quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">ccode_name</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="s2">&quot;particle-&gt;cxi, particle-&gt;cyi, particle-&gt;czi, particle-&gt;cti, &amp;</span><span class="si">%s</span><span class="s2">, &amp;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">varU</span><span class="p">,</span> <span class="n">varV</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">interp_method</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span></div>


<span class="k">class</span> <span class="nc">DeferredArray</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Class used for throwing error when Field.data is not read in deferred loading mode&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Field is in deferred_load mode, so can&#39;&#39;t be accessed. Use .computeTimeChunk() method to force loading of  data&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SummedField"><a class="viewcode-back" href="../../index.html#parcels.field.SummedField">[docs]</a><span class="k">class</span> <span class="nc">SummedField</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class SummedField is a list of Fields over which Field interpolation</span>
<span class="sd">    is summed. This can e.g. be used when combining multiple flow fields,</span>
<span class="sd">    where the total flow is the sum of all the individual flows.</span>
<span class="sd">    Note that the individual Fields can be on different Grids.</span>
<span class="sd">    Also note that, since SummedFields are lists, the individual Fields can</span>
<span class="sd">    still be queried through their list index (e.g. SummedField[1]).</span>
<span class="sd">    SummedField is composed of either Fields or VectorFields.</span>

<span class="sd">    :param name: Name of the SummedField</span>
<span class="sd">    :param F: List of fields. F can be a scalar Field, a VectorField, or the zonal component (U) of the VectorField</span>
<span class="sd">    :param V: List of fields defining the meridional component of a VectorField, if F is the zonal component. (default: None)</span>
<span class="sd">    :param W: List of fields defining the vertical component of a VectorField, if F and V are the zonal and meridional components (default: None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VectorField</span><span class="p">):</span>
                <span class="n">vector_type</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector_type</span>
            <span class="k">for</span> <span class="n">Fi</span> <span class="ow">in</span> <span class="n">F</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">VectorField</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Fi</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="n">vector_type</span><span class="p">),</span> <span class="s1">&#39;Components of a SummedField must be Field or VectorField&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">W</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Vi</span><span class="p">,</span> <span class="n">Field</span><span class="p">),</span> \
                    <span class="s1">&#39;F, and V components of a SummedField must be Field&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VectorField</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">,</span> <span class="n">Wi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Vi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Wi</span><span class="p">,</span> <span class="n">Field</span><span class="p">),</span> \
                    <span class="s1">&#39;F, V and W components of a SummedField must be Field&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VectorField</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">,</span> <span class="n">Wi</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">iField</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iField</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">)),</span> <span class="s1">&#39;Fields in a SummedField should be either all scalars or all vectors&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">SummedField</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="s1">&#39;Fields in a SummedField should be either all scalars or all vectors&#39;</span>
            <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fld</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="NestedField"><a class="viewcode-back" href="../../index.html#parcels.field.NestedField">[docs]</a><span class="k">class</span> <span class="nc">NestedField</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class NestedField is a list of Fields from which the first one to be not declared out-of-boundaries</span>
<span class="sd">    at particle position is interpolated. This induces that the order of the fields in the list matters.</span>
<span class="sd">    Each one it its turn, a field is interpolated: if the interpolation succeeds or if an error other</span>
<span class="sd">    than `ErrorOutOfBounds` is thrown, the function is stopped. Otherwise, next field is interpolated.</span>
<span class="sd">    NestedField returns an `ErrorOutOfBounds` only if last field is as well out of boundaries.</span>
<span class="sd">    NestedField is composed of either Fields or VectorFields.</span>

<span class="sd">    :param name: Name of the NestedField</span>
<span class="sd">    :param F: List of fields (order matters). F can be a scalar Field, a VectorField, or the zonal component (U) of the VectorField</span>
<span class="sd">    :param V: List of fields defining the meridional component of a VectorField, if F is the zonal component. (default: None)</span>
<span class="sd">    :param W: List of fields defining the vertical component of a VectorField, if F and V are the zonal and meridional components (default: None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VectorField</span><span class="p">):</span>
                <span class="n">vector_type</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector_type</span>
            <span class="k">for</span> <span class="n">Fi</span> <span class="ow">in</span> <span class="n">F</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">VectorField</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Fi</span><span class="o">.</span><span class="n">vector_type</span> <span class="o">==</span> <span class="n">vector_type</span><span class="p">),</span> <span class="s1">&#39;Components of a NestedField must be Field or VectorField&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">W</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Vi</span><span class="p">,</span> <span class="n">Field</span><span class="p">),</span> \
                    <span class="s1">&#39;F, and V components of a NestedField must be Field&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VectorField</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">,</span> <span class="n">Wi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="n">F</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Vi</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Wi</span><span class="p">,</span> <span class="n">Field</span><span class="p">),</span> \
                    <span class="s1">&#39;F, V and W components of a NestedField must be Field&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VectorField</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Vi</span><span class="p">,</span> <span class="n">Wi</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iField</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iField</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">FieldOutOfBoundError</span><span class="p">,</span> <span class="n">FieldSamplingError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">iField</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">return</span> <span class="n">val</span></div>


<span class="k">class</span> <span class="nc">NetcdfFileBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class that encapsulates and manages deferred access to file data. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">netcdf_engine</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interp_method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">data_full_zdim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_chunksize</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>  <span class="c1"># Dict with dimension keys for file data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">=</span> <span class="n">netcdf_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="o">=</span> <span class="n">interp_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span> <span class="o">=</span> <span class="n">data_full_zdim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="o">=</span> <span class="n">field_chunksize</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">decode_cf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;decoded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> could not be decoded properly by xarray (version </span><span class="si">%s</span><span class="s2">).</span><span class="se">\n</span><span class="s2">         It will be opened with no decoding. Filling values might be wrongly parsed.&quot;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">decode_cf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;decoded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">inds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Indices for field subsetting need to be a list&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">nm</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;None of variables in list found in file&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read_lonlat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]]</span>
        <span class="n">xdim</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ydim</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">xdim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;lat&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">ydim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lon_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
            <span class="n">lat_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lon_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
            <span class="n">lat_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># some lon, lat have a time dimension 1</span>
            <span class="n">lon_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
            <span class="n">lat_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># some lon, lat have a time and depth dimension 1</span>
            <span class="n">lon_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
            <span class="n">lat_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Tests if lon, lat are rectilinear but were stored in arrays</span>
            <span class="n">rectilinear</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># test if all columns and rows are the same for lon and lat (in which case grid is rectilinear)</span>
            <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lon_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">lon_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lon_subset</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="p">:]):</span>
                    <span class="n">rectilinear</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">rectilinear</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">lat_subset</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lat_subset</span><span class="p">[:,</span> <span class="n">yi</span><span class="p">]):</span>
                        <span class="n">rectilinear</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">rectilinear</span><span class="p">:</span>
                <span class="n">lon_subset</span> <span class="o">=</span> <span class="n">lon_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">lat_subset</span> <span class="o">=</span> <span class="n">lat_subset</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lon_subset</span><span class="p">,</span> <span class="n">lat_subset</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]]</span>
            <span class="n">depthsize</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span> <span class="o">=</span> <span class="n">depthsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">depthsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Time varying depth data cannot be read in netcdf files yet&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]:</span>
                <span class="c1"># Add a bottom level of zeros for B-grid if missing in the data.</span>
                <span class="c1"># The last level is unused by B-grid interpolator (U, V, tracer) but must be there</span>
                <span class="c1"># to match Parcels data shape. for W, last level must be 0 for impermeability</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;For B grids, indices must be provided as a range&quot;</span><span class="p">)</span>
                        <span class="c1"># this is because da.concatenate needs data which are indexed using slices, not a range of indices</span>
                <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">lat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">lon0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lon1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">d0</span><span class="p">:</span><span class="n">d1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">:</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon0</span><span class="p">:</span><span class="n">lon1</span><span class="p">],</span>
                                       <span class="n">da</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat1</span><span class="o">-</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="o">-</span><span class="n">lon0</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_full_zdim</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bgrid_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_w_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;bgrid_tracer&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;For B grids, indices must be provided as a range&quot;</span><span class="p">)</span>
                        <span class="c1"># this is because da.concatenate needs data which are indexed using slices, not a range of indices</span>
                <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">lat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">lon0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lon1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">]):</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">t0</span><span class="p">:</span><span class="n">t1</span><span class="p">,</span> <span class="n">d0</span><span class="p">:</span><span class="n">d1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">:</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon0</span><span class="p">:</span><span class="n">lon1</span><span class="p">],</span>
                                           <span class="n">da</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lat1</span><span class="o">-</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="o">-</span><span class="n">lon0</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">d0</span><span class="p">:</span><span class="n">d1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">:</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon0</span><span class="p">:</span><span class="n">lon1</span><span class="p">],</span>
                                           <span class="n">da</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat1</span><span class="o">-</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="o">-</span><span class="n">lon0</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">da_data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_chunksize</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">da_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">da_data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">da_data</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>

        <span class="n">time_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netcdf_engine</span> <span class="o">!=</span> <span class="s1">&#39;xarray&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;decoded&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;Unit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">time_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time_da</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_da</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_da</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">time_da</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;Unit&#39;</span> <span class="ow">in</span> <span class="n">time_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">time_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span> <span class="n">time_da</span><span class="p">})</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Xarray could not convert the calendar. Try using the timestamps &#39;</span>
                                   <span class="s1">&#39;keyword in the construction of your Field </span><span class="si">%s</span><span class="s1">. See also the tutorial &#39;</span>
                                   <span class="s1">&#39;at https://nbviewer.jupyter.org/github/OceanParcels/parcels/blob/master&#39;</span>
                                   <span class="s1">&#39;/parcels/examples/tutorial_timestamps.ipynb&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">da</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Parcels currently only parses dates ranging from 1678 AD to 2262 AD, which are stored by xarray as np.datetime64. If you need a wider date range, please open an Issue on the parcels github page.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Parcels  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Michael Lange and Erik van Sebille.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>